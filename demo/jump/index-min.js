define(function(){var a,b,c=COM.Com,d=COM.Sprite,e=COM.SpriteSheet,f=Matrix.Loader,g=Matrix.Timer,h={runner:"./image/runner.png",hill:"./image/hill.png",sky:"./image/bg.png",blood:"./image/blood.png",ground:"./image/ground.png",start:"./image/start.png",over:"./image/over.png",arrow:"./image/arrow.png"},i=9.81,j=60,k=10,l=100,m=60,n=20,o=40*Math.random()+30,p=70,q=360/(Math.PI*o/70),r=80;return{score:0,calculateAccelerate:function(a,b,c){var d=a*b*k;c.x+=d,c.x<0?c.x=0:c.x>this.stage.width-c.width&&(c.x=this.stage.width-c.width),c.framerate=Math.abs(d)>1&&!c.Jumping?0:1,c.scaleX=d>=0?1:-1},hitTestCircle:function(a,b){var c={x:a.x+a.width/2,y:a.y+a.height/2,r:a.width/2},d={x:b.x+b.width/2,y:b.y+b.height/2,r:b.width/2},e=Math.sqrt(Math.pow(c.x-d.x,2)+Math.pow(c.y-d.y,2));return e<c.r+d.r},hitTestArrow:function(a,b){for(var c={x:a.x+a.width/2,y:a.y+a.height/2,r:a.width/2},d=0;d<b.length;d++){var e=b[d],f={x:e.x+e.width/2-e.tan*(e.height/2),y:e.y+e.height},g=Math.sqrt(Math.pow(c.x-f.x,2)+Math.pow(c.y-f.y,2));if(g<c.r)return!0}return!1},gameStart:function(){var d=this;d.gamePlaying=!0,d.score=0,b?(a.x=0,a.y=d.stage.height-60-90,a.die=!1,a.play("run"),a.visible=!0,b.x=-b.width):(b=new c({x:d.stage.width,y:d.stage.height-60-o,width:o,height:o,zIndex:300,backgroundImage:d.loader.get("ground"),shape:c.Shape.Circle,painter:c.Painter.Bitmap}).on("render:before",function(a){if(this.x<-this.width){this.x=d.stage.width+250*Math.random();var b=40*Math.random()+30;this.width=b,this.height=b,this.y=d.stage.height-60-b,q=360/(Math.PI*b/p)}else this.x-=(p+l)*a;this.rotate-=q*a}),d.stage.append(b))},init:function(){var k=this,o=document.getElementById("canvas");o.width=document.body.getBoundingClientRect().width,o.height=document.body.getBoundingClientRect().height;var p=new f(h),q=new c(o),s=new g;return k.stage=q,k.loader=p,p.on("complete",function(){function f(){for(var a=2*Math.ceil(q.width/320),b=0;a>b;b++){var d=new c({x:b*q.width,y:-58,width:13,height:58,zIndex:200,visible:!1,velocityY:0,backgroundImage:p.get("arrow"),shape:c.Shape.Rect,painter:c.Painter.Bitmap});q.append(d),E.push(d)}}function g(){D.text=k.score}function h(a,b){if(a.visible||(a.visible=!0),a.dropping){if(a.y==-a.height){var c,d=q.width*Math.random();a.x=q.width*Math.random(),c=(a.x-d)/(q.height-60-58),a.rotate=Math.atan(c)/Math.PI*180,a.tan=c}else a.y>q.height-60-58*Math.cos(a.rotate*Math.PI/180)&&(a.dropping=!1,a.hitLand=!0,k.gamePlaying&&k.score++);a.velocityY+=i*b*j;var e=a.velocityY*b;a.y+=e,a.x-=a.tan*e}else a.hitLand&&(a.x<-20?(a.dropping=!0,a.hitLand=!1,a.y=-a.height,a.velocityY=0):a.x-=l*b)}function t(a){for(var b=0;b<E.length;b++){var c=E[b];c.dropping=a,c.visible=a,a&&(c.velocityY=0,c.y=-c.height)}}function u(){a.visible=!1,B.visible=!0,C.visible=!0,k.gamePlaying=!1,t(!1),new TWEEN.Tween({y:0-C.height}).to({y:r},500).easing(TWEEN.Easing.Back.Out).onUpdate(function(){C.y=this.y}).start(),new TWEEN.Tween({x:0-B.width}).to({x:q.width/2-55},500).easing(TWEEN.Easing.Back.Out).onUpdate(function(){B.x=this.x}).start()}var v=document.getElementById("loading");v.style.display="none";var w={over:!0,jump:function(a){var b=this,c=a.y;if(b.over&&!a.die){var d=new TWEEN.Tween({y:c}).to({y:c-50},600).easing(TWEEN.Easing.Quintic.Out).onUpdate(function(){a.die&&(b.over=!0),a.y=this.y}),e=new TWEEN.Tween({y:c-50}).to({y:c},600).easing(TWEEN.Easing.Quartic.In).onUpdate(function(){a.die&&(b.over=!0),a.y=this.y,a.y==c&&(b.over=!0)});d.chain(e).start(),b.over=!1}}},x={over:!0,die:function(a,b){var c=this,d=a.y;if(c.over){a.Jumping=!1,a.stop();var e=new TWEEN.Tween({y:d}).to({y:d-30},500).easing(TWEEN.Easing.Quartic.Out).onUpdate(function(){a.y=this.y}),f=new TWEEN.Tween({y:d-30}).to({y:q.height},800).easing(TWEEN.Easing.Quartic.In).onUpdate(function(){a.y=this.y}).onComplete(function(){c.over=!0,b&&b.call(k)});e.chain(f).start(),c.over=!1}}},y=new c({width:q.width,height:q.height-60,backgroundImage:p.get("sky"),imagePositionX:0,backgroundRepeatX:!0,shape:c.Shape.Rect,painter:c.Painter.Bitmap}),z=new c({y:o.height-60,width:o.width,height:60,zIndex:202,backgroundImage:p.get("ground"),imagePositionX:0,backgroundRepeatX:!0,shape:c.Shape.Rect,painter:c.Painter.Bitmap}),A=new c({x:o.width*Math.random(),y:o.height-60-118,width:564,height:118,zIndex:20,backgroundImage:p.get("hill"),shape:c.Shape.Rect,painter:c.Painter.Bitmap}),B=new c({id:"start",x:q.width/2-55,y:140,width:110,height:60,backgroundImage:p.get("start"),shape:c.Shape.Rect,painter:c.Painter.Bitmap}),C=new c({id:"gameover",x:q.width/2-99,y:-50,width:198,height:50,visible:!1,zIndex:199,backgroundImage:p.get("over"),shape:c.Shape.Rect,painter:c.Painter.Bitmap}),D=new c({id:"score",x:q.width/2,y:240,width:60,height:50,text:0,fillColor:"white",font:"30px Palatino",visible:!1,shape:c.Shape.Rect,painter:c.Painter.Text}),E=[],F=new e({image:k.loader.get("blood"),frameData:{imgWidth:450,imgHeight:64,frameWidth:64,frameHeight:64,frameNum:6}}),G=new d({width:50,height:50,visible:!1,framerate:3,shape:c.Shape.Rect,painter:F}),H=new e({image:k.loader.get("runner"),frameData:{imgWidth:2048,imgHeight:2048,frameWidth:165,frameHeight:292,frameNum:64},animations:{run:{start:0,end:25,loop:!0},jump:{start:26,end:63},stand:{start:58,end:60,loop:!0}}});a=new d({x:50,y:k.stage.height-60-90,width:50,height:90,zIndex:400,shape:c.Shape.Rect,painter:H,loop:!0,autoPlay:!0,skewX:10,skewY:30}),q.append(y),q.append(z),q.append(A),q.append(a),q.append(G),q.append(B),q.append(C),q.append(D),f(),q.delegate("touchstart","",function(b){"start"!=b.targetCom.id&&(a.die||a.Jumping||(a.framerate=1,a.Jumping=!0,a.play("jump",function(){a.framerate=0,a.Jumping=!1,this.play("run")}),w.jump(a)))}),q.delegate("touchstart","start",function(){k.gameStart(),t(!0),new TWEEN.Tween({x:q.width/2-55}).to({x:0-B.width},500).easing(TWEEN.Easing.Back.Out).onUpdate(function(){B.x=this.x}).onComplete(function(){B.visible=!1}).start(),C.visible&&new TWEEN.Tween({y:r}).to({y:0-C.height},500).easing(TWEEN.Easing.Back.In).onUpdate(function(){C.y=this.y}).onComplete(function(){C.visible=!1}).start()});var I=0;window.addEventListener("deviceorientation",function(a){I=a.gamma});var J=0,K=!1;window.navigator.userAgent.match(/Android/)&&(K=!0),s.on("run",function(c){if(z.imagePositionX>=z.maxPositionX?z.imagePositionX=z.imagePositionX-z.maxPositionX:z.imagePositionX+=l*c,A.x=A.x<-A.width?q.width+60:A.x-m*c,y.imagePositionX>=y.maxPositionX?y.imagePositionX=0:y.imagePositionX+=n*c,TWEEN.update(),k.gamePlaying){D.visible=!0,a.die||k.calculateAccelerate(I,c,a);for(var d=0;d<E.length;d++)h(E[d],c);a.die||!k.hitTestArrow(a,E)&&!k.hitTestCircle(a,b)||(console.log("die"),a.die=!0,G.x=a.x-7,G.y=a.y+13,G.visible=!0,G.play("",function(){G.visible=!1}),x.die(a,function(){u()}))}g(),q.clear(),q.render(c),J+=c,J>1&&(J=0,fps.innerHTML="FPS:"+Math.floor(1/c))}).start()}),s}}});